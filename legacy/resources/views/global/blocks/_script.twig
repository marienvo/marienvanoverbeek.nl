<script>

    $(document).ready(function() {
        var windowTitle=$('head>title');
        var original_title = windowTitle.html();
        var content = $("#content");
        var tpage, headerHeight;
        var regEx = new RegExp('/', 'g');
        var page = "{{ p }}".replace(regEx,"_");
        var colors = [];
        var titles = [];
        colors["curriculum-vitae"] = "#428BCA";
        {% for project in projects %}
        colors["curriculum-vitae_{{ project.id }}"] = "{{ project.color }}";
        titles["curriculum-vitae_{{ project.id }}"] = "{{ project.data.title }}";
        {% endfor %}

        var getColor = function(tpage) {
            var setColor;
            if(colors[tpage]!=undefined) {
                setColor = colors[tpage];
            } else {
                setColor = "#EAEAEA";
            }
            return setColor;
        }

        /*
         * Set height of headers
         * */
        function setHeights() {
            var height = $(window).height()-100;
            var width = $(window).width();

            /*
             * Set max height of profile based on proportions
             * */
            var maxHeight = height;
            if(width/2<=height) maxHeight = width/2;
            if(height>=maxHeight) height = maxHeight;

            /*
             * Set sizes
             * */
            $(".cv-project").height(height);
            $("#profiel .fixed-inner").height(height).width(width);

            /*
             * Set top of .about (#profiel)
             * */
            $("#profiel .about").css({"margin-top":height *.095-10+"px"});
        }

        /*
         * Page transitioning function
         * */
        function goto(href) {
            tpage = href.replace("/","").replace("/","_");
            content.easytabs('select', '#tab_'+tpage);
            if(tpage=="") {
                windowTitle.html(original_title);
            } else {
                windowTitle.html(titles[tpage]);
            }
            $("html, body").animate({ scrollTop: "0px" }, 1000);
            headerHeight = $("#profiel .fixed-inner").height();
            content.css({"background-color":getColor(tpage)});
        }

        /*
         * Trianglify Headers
         * */
        function trianglify(target, page) {
            var setColor = getColor(page);
            var height = $(window).height()-$('nav.menu').height();
            var width = $(window).width();
            var maxHeight = height;

            if(width/2<=height) maxHeight = width/2;
            if(height>=maxHeight) height = maxHeight;

            var pattern = Trianglify({
                width: window.innerWidth,
                height: height+1,
                cell_size: 90,
                variance: 0.5,
                x_colors: [setColor,setColor],
                y_colors: ["#000000",setColor,"#ffffff"]
            });
            $(target).html(pattern.canvas());
        }

        /*
         * AJAX Page
         * */
        function ajaxPage(dest, page, tpage) {
            var destination = $(dest);
            var uri = destination.data("src");
            destination.css({"min-height":$(window).height()*2});
            if(uri != undefined) {
                $(dest).load(uri, function() {

                    /*
                     * Project carousels
                     * */
                    var allCarouFredSels = new Array();
                    $('.auto-carousel').each(function(){
                        var id = "#"+$(this).attr('id');
                        allCarouFredSels.push(id);
                    });
                    for(var i = 0; i < allCarouFredSels.length; i++) {
                        var carousel = $(allCarouFredSels[i]);
                        if(carousel.length) {
                            carousel.carouFredSel({
                                circular: true,
                                infinite: true,
                                responsive: true,
                                direction: "left",
                                width: "100%",
                                height:"variable",
                                items: {
                                    visible: {
                                        min: 1,
                                        max: 1
                                    },
                                    height:"variable",
                                    width: '1000'
                                }
                            });
                        }
                    }

                    /*
                     * Finalize things
                     */
                    if(page) {
                        windowTitle.html(titles[page]);
                        trianglify("#"+page+" .bg-triangle", page);
                    } else {
                        windowTitle.html(titles[page]);
                        trianglify("#"+tpage+" .bg-triangle", tpage);
                    }

                    $(window).resize(function() {
                        if(page) trianglify("#"+page+" .bg-triangle", page);
                        if(tpage) trianglify("#"+tpage+" .bg-triangle", tpage);
                    });

                    // Set min-height back to default
                    destination.css({"min-height":0});

                    $(window).resize(setHeights);
                    setHeights();
                });

            }
        }

        /*
         * Browser history controller
         * */
        $(window).on("popstate", function() {
            goto(location.pathname);
        });

        /*
         * Click controller
         * */
        $("body").on('click', 'a[data-push-state="true"]', function(e){
            e.preventDefault();
            var href = $(this).attr("href");
            history.pushState({}, '', href);
            goto(href);
        });

        // Prevent focus on links
        $("body").on('mousedown', 'a[data-push-state="true"]', function(e){
            e.preventDefault();
        });

        /*
         * Run EasyTabs
         * */
        var contentBlock;
        var defaultTab = "li#tab_"+page;
        ajaxPage("#"+page, page, false);
        switch($(defaultTab.replace(regEx,'_')).length) {
            case 0:
                window.location.replace("http://www.marienvanoverbeek.nl");
                break;

            default:
                content.easytabs({
                    defaultTab          : defaultTab,
                    animate			    : true,
                    updateHash		    : true,
                    transitionIn		: 'fadeIn',
                    transitionOut		: 'fadeOut',
                    animationSpeed	    : 400,
                    tabs				: ".tmenu",
                    tabActiveClass	    : 'active'
                }).bind('easytabs:before', function() {
                    if(tpage=="") {
                        contentBlock = content.find(".active > .cv-text");
                    } else {
                        contentBlock = $("#"+tpage+" > .cv-text");
                    }
                    if(tpage) trianglify("#"+tpage+" .bg-triangle", tpage);
                    ajaxPage("#"+tpage, false, tpage);
                }).bind('easytabs:after', function() {
                    if(tpage=="") {
                        contentBlock = content.find(".active > .cv-text");
                    } else {
                        contentBlock = $("#"+tpage+" > .cv-text");
                    }

                    // (Re)set mobile scrollers
                    var allMobileScrollers = new Array();
                    $('.auto-iphone').each(function(){
                        var id = "#"+$(this).attr('id');
                        allMobileScrollers.push(id);
                    });
                    for(var j = 0; j < allMobileScrollers.length; j++) {
                        var MobileScroll = allMobileScrollers[j];
                        if ($(MobileScroll).length) {
                            var myScroll;
                            myScroll = new IScroll(MobileScroll);
                        }
                    }

                    // (Re)set carousels
                    var allCarouFredSels = new Array();
                    $('.auto-carousel').each(function(){
                        var id = "#"+$(this).attr('id');
                        allCarouFredSels.push(id);
                    });
                    for(var i = 0; i < allCarouFredSels.length; i++) {
                        var carousel = $(allCarouFredSels[i]);
                        if($(carousel).length) {
                            carousel.trigger('updateSizes').trigger('resume');
                        }
                    }
                    $('#carousel_home_logos').trigger('updateSizes').trigger('resume');
                    $('#projecten').trigger('updateSizes').trigger('resume');

                });

                $(window).resize(setHeights);
                setHeights();

                $(window).load(function() {
                    $('.loading-screen').delay(10).fadeOut();
                });

        }

    });
</script>